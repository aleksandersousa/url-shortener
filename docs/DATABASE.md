# Database Schema

## Database System

**PostgreSQL** (RDS in production, local for development)

---

## Connection

**Connection String Format:**

```
postgresql://username:password@host:port/database
```

**Environment Variable:**

- `DATABASE_URL`: Full connection string

---

## Schema

### Table: urls

Stores the mapping between short codes and original URLs.

**Columns:**

| Column       | Type        | Constraints                                      | Description                                       |
| ------------ | ----------- | ------------------------------------------------ | ------------------------------------------------- |
| id           | UUID        | PRIMARY KEY, NOT NULL, DEFAULT gen_random_uuid() | Internal unique identifier                        |
| code         | VARCHAR(10) | UNIQUE, NOT NULL                                 | Short alphanumeric code (6 characters by default) |
| original_url | TEXT        | NOT NULL                                         | Original full URL to redirect to                  |
| access_count | INTEGER     | NOT NULL, DEFAULT 0                              | Counter for number of times the URL was accessed  |
| created_at   | TIMESTAMP   | NOT NULL, DEFAULT CURRENT_TIMESTAMP              | Creation timestamp                                |

**Indexes:**

1. **Primary Key Index** on `id`

   - Automatically created by PostgreSQL
   - Unique constraint

2. **Unique Index** on `code`

   - Ensures code uniqueness
   - Used for fast lookups during redirects
   - Index name: `idx_urls_code_unique`

3. **Index** on `code` (for performance)
   - Additional index for query optimization
   - Index name: `idx_urls_code`

**Constraints:**

- `id` must be a valid UUID v4
- `code` must be unique across all records
- `code` length: 6 characters (configurable via `CODE_LENGTH` env var)
- `original_url` must be a valid URL (validated at application level)
- `access_count` cannot be negative (application-level validation)
- `created_at` is automatically set on insert

---

## SQL Schema

```sql
CREATE TABLE urls (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    code VARCHAR(10) NOT NULL UNIQUE,
    original_url TEXT NOT NULL,
    access_count INTEGER NOT NULL DEFAULT 0,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_urls_code ON urls(code);
```

---

## Data Types Details

**UUID:**

- Format: Version 4 (random)
- Example: `550e8400-e29b-41d4-a716-446655440000`
- Generated by PostgreSQL function `gen_random_uuid()`

**VARCHAR(10):**

- Maximum length: 10 characters
- Used for short codes (default 6 characters)
- Alphanumeric characters only (a-z, A-Z, 0-9)

**TEXT:**

- Unlimited length
- Used for original URLs (can be very long)

**INTEGER:**

- 32-bit signed integer
- Range: -2,147,483,648 to 2,147,483,647
- Sufficient for access counting

**TIMESTAMP:**

- Timezone-aware timestamp
- Format: ISO 8601
- Example: `2024-01-15 10:30:00.000000`

---

## Migration Strategy

**Approach:**

- Manual SQL scripts for schema creation
- No migration framework in initial phase (simplicity)
- Schema changes documented in this file

**Future Considerations:**

- May introduce migration framework (e.g., TypeORM migrations) if needed
- Version control for schema changes

---

## Query Patterns

**Common Queries:**

1. **Find by code (redirect):**

   ```sql
   SELECT original_url FROM urls WHERE code = $1;
   ```

2. **Increment access count:**

   ```sql
   UPDATE urls SET access_count = access_count + 1 WHERE code = $1;
   ```

3. **Check code existence (uniqueness):**

   ```sql
   SELECT COUNT(*) FROM urls WHERE code = $1;
   ```

4. **Insert new URL:**
   ```sql
   INSERT INTO urls (code, original_url) VALUES ($1, $2) RETURNING id, code, original_url, access_count, created_at;
   ```

---

## Performance Considerations

- Index on `code` ensures O(log n) lookup time
- Unique constraint prevents duplicate codes
- No complex joins required (single table)
- Access count updates are atomic operations

---

## Future Schema Evolutions (Not Now)

- `expires_at`: Timestamp for URL expiration
- `user_id`: Foreign key for user association (if authentication added)
- `custom_code`: Boolean flag for custom vs generated codes
- `deleted_at`: Soft delete timestamp

These are **not** part of the current schema.
