---
description: Database schema, query patterns, and repository guidelines
globs: ["**/*.repository.ts"]
---

# Database Patterns

## Schema: urls

- `id`: UUID (PRIMARY KEY, DEFAULT gen_random_uuid())
- `code`: VARCHAR(10) (UNIQUE, NOT NULL, INDEX)
- `original_url`: TEXT (NOT NULL)
- `access_count`: INTEGER (NOT NULL, DEFAULT 0)
- `created_at`: TIMESTAMP (NOT NULL, DEFAULT CURRENT_TIMESTAMP)

## Query Patterns

- Find by code: `SELECT original_url FROM urls WHERE code = $1;`
- Increment count: `UPDATE urls SET access_count = access_count + 1 WHERE code = $1;`
- Check existence: `SELECT COUNT(*) FROM urls WHERE code = $1;`
- Insert: `INSERT INTO urls (code, original_url) VALUES ($1, $2) RETURNING *;`

## Repository Pattern

- Use parameterized queries (prevent SQL injection)
- Handle database errors appropriately
- Log only technical errors
- Return domain entities, not raw database rows

## Connection

- Environment variable: `DATABASE_URL`
- Format: `postgresql://username:password@host:port/database`
- Access via `ConfigService` from `@nestjs/config` module
- Use `configService.getOrThrow<string>("DATABASE_URL")` for type-safe access
